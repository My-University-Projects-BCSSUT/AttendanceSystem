@model AttendanceSystem.Models.AttendanceSession

@{
    ViewData["Title"] = "Attendance Session";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-lg">
            <div class="card-header bg-success text-white text-center">
                <h3 class="mb-0">
                    <i class="fas fa-qrcode"></i> Attendance Session Active
                </h3>
            </div>
            <div class="card-body text-center p-5">
                <h4 class="mb-3">@Model.Class.Course.GetFullCourseName()</h4>
                <h5 class="text-muted mb-4">@Model.Class.Name</h5>

                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i> 
                    Students should scan this QR code to mark their attendance
                </div>

                <!-- QR Code Display -->
                <div class="qr-code-container mb-4">
                    <img src="data:image/png;base64,@ViewBag.QRCodeBase64" 
                         alt="Attendance QR Code" 
                         class="img-fluid" 
                         style="max-width: 400px;" />
                </div>

                <div class="mb-3">
                    <h6>Session Code:</h6>
                    <code class="fs-4">@Model.QRCode</code>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-clock"></i> 
                    <strong>Expires at:</strong> @Model.QRCodeExpiresAt.ToLocalTime().ToString("hh:mm tt")
                </div>

                <div class="mb-4">
                    <p class="mb-1"><strong>Session Date:</strong> @Model.SessionDate.ToString("MMM dd, yyyy")</p>
                    <p class="mb-1"><strong>Class Time:</strong> @Model.Class.GetScheduleInfo()</p>
                </div>

                <div id="attendanceCount" class="mb-4">
                    <h5>Attendance Count: <span id="count" class="badge bg-primary">0</span></h5>
                </div>

                <div class="d-grid gap-2">
                    <button onclick="refreshAttendance()" class="btn btn-info btn-lg">
                        <i class="fas fa-sync"></i> Refresh Count
                    </button>
                    <a asp-action="EndSession" asp-route-id="@Model.Id" 
                       class="btn btn-danger btn-lg"
                       onclick="return confirm('Are you sure you want to end this session?')">
                        <i class="fas fa-stop"></i> End Session
                    </a>
                    <a asp-action="MyClasses" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to My Classes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refreshAttendance() {
            // In a real application, this would fetch the count via AJAX
            fetch('/Teacher/GetAttendanceCount?sessionId=@Model.Id')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('count').textContent = data.count;
                })
                .catch(error => {
                    console.error('Error fetching attendance count:', error);
                });
        }

        // Auto-refresh every 10 seconds
        setInterval(refreshAttendance, 10000);
    </script>
}
