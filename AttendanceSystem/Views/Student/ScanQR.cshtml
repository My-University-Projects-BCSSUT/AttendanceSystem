@{
    ViewData["Title"] = "Scan QR Code";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">
                    <i class="fas fa-qrcode"></i> Submit Attendance
                </h2>

                <!-- Manual Entry Section -->
                <div class="alert alert-info">
                    <i class="fas fa-keyboard"></i> 
                    <strong>Option 1:</strong> Enter the session code displayed by your teacher
                </div>

                <form asp-action="SubmitAttendance" method="post" id="attendanceForm">
                    <div class="mb-4">
                        <label for="qrCode" class="form-label">Session Code</label>
                        <input type="text" 
                               class="form-control form-control-lg text-center" 
                               id="qrCode" 
                               name="qrCode" 
                               placeholder="Enter or scan session code"
                               required 
                               autofocus />
                        <div class="form-text">
                            The session code is displayed with the QR code by your teacher
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check"></i> Submit Attendance
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>

                <hr class="my-4" />

                <!-- QR Scanner Section -->
                <div class="alert alert-success">
                    <i class="fas fa-camera"></i> 
                    <strong>Option 2:</strong> Use your device camera to scan the QR code
                </div>

                <div class="text-center" id="scanner-section">
                    <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto; display: none;"></div>
                    <div id="scanner-controls">
                        <button id="start-scan" class="btn btn-success btn-lg mb-3">
                            <i class="fas fa-camera"></i> Start Camera Scanner
                        </button>
                        <button id="stop-scan" class="btn btn-danger btn-lg mb-3" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                    </div>
                    <div id="scanner-status" class="alert alert-warning mt-3" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> <span id="status-text">Initializing camera...</span>
                    </div>
                </div>

                <div class="alert alert-secondary mt-3">
                    <h6><i class="fas fa-info-circle"></i> Tips for Mobile Users:</h6>
                    <ul class="mb-0">
                        <li>You can also use your phone's native camera app to scan QR codes</li>
                        <li>Grant camera permissions when prompted</li>
                        <li>Make sure you're in good lighting</li>
                        <li>Hold the QR code steady within the frame</li>
                    </ul>
                </div>
            </div>
        </div>

        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger mt-3">
                <i class="fas fa-exclamation-circle"></i> @ViewBag.ErrorMessage
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        let html5QrCode = null;
        let isScanning = false;
        let isSubmitting = false;
        
        const startButton = document.getElementById('start-scan');
        const stopButton = document.getElementById('stop-scan');
        const readerDiv = document.getElementById('qr-reader');
        const statusDiv = document.getElementById('scanner-status');
        const statusText = document.getElementById('status-text');
        const qrCodeInput = document.getElementById('qrCode');
        const attendanceForm = document.getElementById('attendanceForm');
        
        function showStatus(message, isError = false) {
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            statusDiv.className = isError ? 'alert alert-danger mt-3' : 'alert alert-info mt-3';
        }
        
        function hideStatus() {
            statusDiv.style.display = 'none';
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            // Prevent multiple submissions
            if (isSubmitting) {
                return;
            }
            isSubmitting = true;
            
            // Show status
            showStatus('QR Code detected! Submitting...', false);
            
            // Stop the scanner immediately
            html5QrCode.stop().then(() => {
                isScanning = false;
                readerDiv.style.display = 'none';
                
                // Parse the QR code - it might be JSON
                let qrCode = decodedText;
                try {
                    const qrData = JSON.parse(decodedText);
                    if (qrData.code) {
                        qrCode = qrData.code;
                    }
                } catch (e) {
                    // Not JSON, use as-is
                    qrCode = decodedText;
                }
                
                // Set the input value
                qrCodeInput.value = qrCode;
                
                // Submit the form
                attendanceForm.submit();
                
            }).catch((err) => {
                console.error('Stop error:', err);
                
                // Parse the QR code even if stop failed
                let qrCode = decodedText;
                try {
                    const qrData = JSON.parse(decodedText);
                    if (qrData.code) {
                        qrCode = qrData.code;
                    }
                } catch (e) {
                    qrCode = decodedText;
                }
                
                // Still try to submit
                qrCodeInput.value = qrCode;
                attendanceForm.submit();
            });
        }
        
        function onScanFailure(error) {
            // Ignore scan failures - they happen constantly when no QR is in view
        }
        
        startButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (isScanning) return;
            
            startButton.style.display = 'none';
            readerDiv.style.display = 'block';
            showStatus('Starting camera...');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                stopButton.style.display = 'inline-block';
                showStatus('Camera ready! Point at QR code');
            }).catch((err) => {
                console.error('Camera error:', err);
                showStatus('Failed to start camera: ' + err, true);
                startButton.style.display = 'inline-block';
                readerDiv.style.display = 'none';
            });
        });
        
        stopButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    isSubmitting = false;
                    readerDiv.style.display = 'none';
                    startButton.style.display = 'inline-block';
                    stopButton.style.display = 'none';
                    hideStatus();
                }).catch((err) => {
                    console.error('Error stopping:', err);
                });
            }
        });
    </script>
}
